{% extends "base.html" %}
{% block title %}AR Viewer - Model {{ model_id }}{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    
    .ar-container {
        height: 90vh;
        border: 3px solid rgba(255,255,255,0.2);
        border-radius: 20px;
        margin: 20px 0;
        position: relative;
        background: linear-gradient(145deg, #1a1a2e, #16213e);
        overflow: hidden;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
    }
    
    .ar-overlay {
        position: relative;
        padding: 30px;
        z-index: 1000;
        color: white;
        text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
        flex-shrink: 0;
    }
    
    .ar-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .ar-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 20px;
    }
    
    .ar-controls {
        position: relative;
        padding: 20px;
        z-index: 1000;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        flex-shrink: 0;
        background: linear-gradient(145deg, rgba(26,26,46,0.9), rgba(22,33,62,0.9));
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
        .ar-container {
            height: 95vh;
            margin: 10px 0;
        }
        
        .ar-overlay {
            padding: 20px;
        }
        
        .ar-title {
            font-size: 2rem;
        }
        
        .ar-subtitle {
            font-size: 1rem;
        }
        
        .ar-button {
            padding: 10px 15px;
            font-size: 0.8rem;
            min-width: 100px;
        }
        
        .ar-controls {
            padding: 15px;
            gap: 8px;
        }
        
        #arViewer {
            margin: 10px;
            min-height: 300px;
        }
    }
    
    .ar-button {
        background: linear-gradient(45deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
        border: 2px solid rgba(255,255,255,0.3);
        color: white;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        backdrop-filter: blur(15px);
        transition: all 0.3s ease;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        min-width: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .ar-button:hover {
        background: linear-gradient(45deg, rgba(255,255,255,0.3), rgba(255,255,255,0.2));
        border-color: rgba(255,255,255,0.8);
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }
    
    .ar-button.primary {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        border-color: #ff6b6b;
    }
    
    .ar-button.primary:hover {
        background: linear-gradient(45deg, #ee5a24, #ff6b6b);
        transform: translateY(-3px);
        box-shadow: 0 15px 45px rgba(255,107,107,0.4);
    }
    
    .ar-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .ar-button:disabled:hover {
        transform: none;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    

    
    /* 3D Model Container */
    #arViewer {
        flex: 1;
        position: relative;
        min-height: 400px;
        background: linear-gradient(145deg, rgba(26,26,46,0.5), rgba(22,33,62,0.5));
        border-radius: 15px;
        margin: 20px;
        overflow: hidden;
    }
    
    #arViewer canvas {
        border-radius: 15px;
        width: 100% !important;
        height: 100% !important;
    }
    
    .model-info {
        background: rgba(255,255,255,0.1);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
    }
    
    .model-info i {
        font-size: 1.2rem;
        color: #4ecdc4;
    }
    
    .device-check {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        backdrop-filter: blur(10px);
        color: white;
    }
    
    .device-check.success {
        background: rgba(76, 175, 80, 0.2);
        border-color: rgba(76, 175, 80, 0.5);
    }
    
    .device-check.warning {
        background: rgba(255, 193, 7, 0.2);
        border-color: rgba(255, 193, 7, 0.5);
    }
    
    .ar-viewer-content {
        display: flex;
        justify-content: center;
        align-items: center;
        flex: 1;
        color: white;
        text-align: center;
        padding: 40px;
        min-height: 400px;
    }
    
    .ar-ready-icon {
        font-size: 6rem;
        margin-bottom: 30px;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .ar-ready-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 15px;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .ar-ready-subtitle {
        font-size: 1.2rem;
        opacity: 0.8;
        margin-bottom: 30px;
    }
    
    .loading-progress {
        width: 100%;
        max-width: 400px;
        margin: 20px auto;
        background: rgba(255,255,255,0.1);
        border-radius: 25px;
        padding: 3px;
        backdrop-filter: blur(10px);
    }
    
    .progress-bar {
        height: 20px;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        border-radius: 20px;
        transition: width 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(45deg, #4ecdc4, #ff6b6b);
        border-radius: 20px;
        transition: width 0.3s ease;
        position: relative;
    }
    
    .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    
    .ar-features {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .feature-item {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 10px;
        background: rgba(255,255,255,0.05);
        transition: all 0.3s ease;
    }
    
    .feature-item:hover {
        background: rgba(255,255,255,0.1);
        transform: translateX(5px);
    }
    
    .feature-icon {
        font-size: 1.5rem;
        margin-right: 15px;
        color: #4ecdc4;
    }
    
    .model-info-badge {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        display: inline-block;
        margin-bottom: 20px;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .ar-container {
            height: 70vh;
        }
        
        .ar-controls {
            flex-direction: column;
            gap: 10px;
        }
        
        .ar-button {
            width: 200px;
        }
        
        .ar-title {
            font-size: 2rem;
        }
        
        .ar-ready-title {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}" style="color: white;">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('models.list_models') }}" style="color: white;">All Models</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('models.view_model', model_id=model_id) }}" style="color: white;">View Model</a></li>
                    <li class="breadcrumb-item active" style="color: rgba(255,255,255,0.8);">AR Viewer</li>
                </ol>
            </nav>
            
            <div class="model-info">
                <h3><i class="fas fa-vr-cardboard"></i> AR Viewer Experience</h3>
                <p>Model ID: {{ model_id }}</p>
                <p>Experience this 3D model in stunning Augmented Reality. This viewer supports both AR Quick Look (iOS) and WebXR (Android/Web) for an immersive experience.</p>
            </div>
            
            <div class="device-check" id="deviceCheck">
                <h5><i class="fas fa-mobile-alt"></i> Device Compatibility</h5>
                <div id="deviceInfo">Checking device compatibility...</div>
            </div>
            
            <div class="ar-container" id="arContainer">
                <div class="ar-overlay">
                    <div class="ar-title">AR Viewer</div>
                    <div class="ar-subtitle">Point your camera at a flat surface to place the 3D model</div>
                    <div class="model-info">
                        <i class="fas fa-cube"></i>
                        <span>Model: {{ model_id }}</span>
                    </div>
                </div>
                
                <div class="ar-controls">
                    <button class="ar-button primary" onclick="startAR()">
                        <i class="fas fa-play"></i> Start AR
                    </button>
                    <button class="ar-button" onclick="resetAR()">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                    <button class="ar-button" onclick="captureAR()" id="captureBtn">
                        <i class="fas fa-camera"></i> Capture
                    </button>
                    <button class="ar-button" onclick="exitAR()">
                        <i class="fas fa-times"></i> Exit
                    </button>
                </div>
                
                <div id="arViewer">
                    <div class="ar-viewer-content">
                        <div>
                            <div class="ar-ready-icon">
                                <i class="fas fa-vr-cardboard"></i>
                            </div>
                            <div class="ar-ready-title">AR Viewer Ready</div>
                            <div class="ar-ready-subtitle">Click "Start AR" to begin the augmented reality experience</div>
                            <div class="loading-progress" id="loadingProgress" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                                    <div class="progress-text" id="progressText">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="ar-features">
                        <h5><i class="fas fa-star"></i> AR Features</h5>
                        <div class="feature-item">
                            <div class="feature-icon"><i class="fas fa-cube"></i></div>
                            <div>Real-time 3D model placement</div>
                        </div>
                        <!-- <div class="feature-item">
                            <div class="feature-icon"><i class="fas fa-search"></i></div>
                            <div>Advanced surface detection</div>
                        </div> -->
                        <div class="feature-item">
                            <div class="feature-icon"><i class="fas fa-expand-arrows-alt"></i></div>
                            <div>Model scaling and rotation</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon"><i class="fas fa-camera"></i></div>
                            <div>Screenshot capture</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon"><i class="fab fa-apple"></i></div>
                            <div>AR Quick Look support (iOS)</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon"><i class="fab fa-chrome"></i></div>
                            <div>WebXR support (Android/Web)</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="ar-features">
                        <h5><i class="fas fa-info-circle"></i> Instructions</h5>
                        <div class="feature-item">
                            <div class="feature-icon"><i class="fas fa-lightbulb"></i></div>
                            <div>Ensure you have good lighting</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon"><i class="fas fa-crosshairs"></i></div>
                            <div>Point camera at a flat surface</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon"><i class="fas fa-hand-pointer"></i></div>
                            <div>Tap to place the 3D model</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon"><i class="fas fa-hand-rock"></i></div>
                            <div>Use gestures to rotate and scale</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon"><i class="fas fa-walking"></i></div>
                            <div>Move around to view from different angles</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>

<script>
let arSession = null;
let arViewer = null;
// Model data will be loaded dynamically
let modelData = null;
const modelId = '{{ model_id }}';

// Load model data from API
async function loadModelData() {
    try {
        console.log('Loading model data for:', modelId);
        
        if (!modelId) {
            console.error('No model ID provided');
            return false;
        }
        
        const response = await fetch(`/api/models/${modelId}`);
        console.log('API response status:', response.status);
        
        if (!response.ok) {
            console.error('API request failed:', response.status, response.statusText);
            return false;
        }
        
        const data = await response.json();
        console.log('API response data:', data);
        
        if (data.success && data.model) {
            modelData = data.model;
            console.log('Model data loaded successfully:', modelData);
            return true;
        } else {
            console.error('Invalid model data structure:', data);
            return false;
        }
    } catch (error) {
        console.error('Error loading model data:', error);
        return false;
    }
}

// Check device compatibility
function checkDeviceCompatibility() {
    const deviceInfo = document.getElementById('deviceInfo');
    const deviceCheck = document.getElementById('deviceCheck');
    
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);
    const isMobile = isIOS || isAndroid;
    
    let compatibility = '';
    let status = 'warning';
    
    if (isIOS) {
        compatibility = `
            <div class="feature-item">
                <div class="feature-icon"><i class="fab fa-apple"></i></div>
                <div><strong>iOS Device Detected</strong><br>
                ✅ AR Quick Look supported<br>
                ✅ Safari browser recommended<br>
                ✅ iOS 12+ required</div>
            </div>
        `;
        status = 'success';
    } else if (isAndroid) {
        compatibility = `
            <div class="feature-item">
                <div class="feature-icon"><i class="fab fa-android"></i></div>
                <div><strong>Android Device Detected</strong><br>
                ✅ WebXR supported<br>
                ✅ Chrome browser recommended<br>
                ✅ ARCore required</div>
            </div>
        `;
        status = 'success';
    } else {
        compatibility = `
            <div class="feature-item">
                <div class="feature-icon"><i class="fas fa-desktop"></i></div>
                <div><strong>Desktop Device Detected</strong><br>
                ⚠️ Limited AR support<br>
                ⚠️ Use mobile device for full AR experience<br>
                ✅ 3D viewer available</div>
            </div>
        `;
        status = 'warning';
    }
    
    deviceInfo.innerHTML = compatibility;
    deviceCheck.className = `device-check ${status}`;
}

// Update loading progress
function updateLoadingProgress(percentage, status) {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const loadingProgress = document.getElementById('loadingProgress');
    
    if (progressFill && progressText && loadingProgress) {
        progressFill.style.width = percentage + '%';
        progressText.textContent = Math.round(percentage) + '%';
        loadingProgress.style.display = 'block';
        
        if (status) {
            progressText.textContent = Math.round(percentage) + '% - ' + status;
        }
    }
}

// Start AR session
async function startAR() {
    console.log('Starting AR session for model:', modelId);
    
    try {
        // Show loading state
        const startButton = document.querySelector('.ar-button.primary');
        if (startButton) {
            startButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            startButton.disabled = true;
        }
        
        // Load model data first
        console.log('Loading model data...');
        const modelLoaded = await loadModelData();
        
        if (!modelLoaded) {
            console.error('Failed to load model data');
            showToast('Failed to load model data', 'error');
            if (startButton) {
                startButton.innerHTML = '<i class="fas fa-play"></i> Start AR';
                startButton.disabled = false;
            }
            return;
        }
        
        console.log('Model data loaded successfully, checking WebXR support...');
        
        // Check if WebXR is supported
        if ('xr' in navigator) {
            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                console.log('WebXR AR supported:', supported);
                
                if (supported) {
                    console.log('Starting WebXR AR session...');
                    await startWebXR();
                } else {
                    console.log('WebXR not supported, starting fallback AR...');
                    await startFallbackAR();
                }
            } catch (error) {
                console.error('Error checking WebXR support:', error);
                await startFallbackAR();
            }
        } else {
            console.log('WebXR not available, starting fallback AR...');
            await startFallbackAR();
        }
        
        // Reset button state
        if (startButton) {
            startButton.innerHTML = '<i class="fas fa-play"></i> Start AR';
            startButton.disabled = false;
        }
        
    } catch (error) {
        console.error('Error in startAR:', error);
        showToast('Error starting AR session', 'error');
        
        // Reset button state
        const startButton = document.querySelector('.ar-button.primary');
        if (startButton) {
            startButton.innerHTML = '<i class="fas fa-play"></i> Start AR';
            startButton.disabled = false;
        }
    }
}

// Start WebXR AR session
async function startWebXR() {
    try {
        console.log('Starting WebXR AR session');
        updateLoadingProgress(10, 'Initializing AR session...');
        
        const session = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['hit-test', 'dom-overlay'],
            domOverlay: { root: document.getElementById('arViewer') }
        });
        
        arSession = session;
        updateLoadingProgress(30, 'AR session started...');
        
        session.addEventListener('end', () => {
            arSession = null;
        });
        
        // Set up WebXR rendering
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl', { xrCompatible: true });
        
        // Initialize Three.js for WebXR
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera();
        const renderer = new THREE.WebGLRenderer({ canvas, context: gl });
        
        updateLoadingProgress(50, 'Loading 3D model...');
        
        // Load the actual 3D model
        const model = await loadRealModel();
        if (model) {
            scene.add(model);
            updateLoadingProgress(80, 'Model loaded successfully...');
        } else {
            // Fallback to enhanced model
            const fallbackModel = createEnhancedModel();
            scene.add(fallbackModel);
            updateLoadingProgress(80, 'Using enhanced preview...');
        }
        
        // Set up reference space
        const referenceSpace = await session.requestReferenceSpace('viewer');
        const hitTestSource = await session.requestHitTestSource({ space: referenceSpace });
        
        updateLoadingProgress(100, 'AR ready!');
        
        session.requestAnimationFrame((time, frame) => {
            if (frame) {
                const hitTestResults = frame.getHitTestResults(hitTestSource);
                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const pose = hit.getPose(referenceSpace);
                    if (model) {
                        model.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
                    }
                }
            }
            renderer.render(scene, camera);
            session.requestAnimationFrame(arguments.callee);
        });
        
    } catch (error) {
        console.error('WebXR not supported:', error);
        startFallbackAR();
    }
}

// Load real 3D model from API
async function loadRealModel() {
    try {
        console.log('Loading real model for:', modelId);
        
        if (!modelData) {
            console.error('No model data available');
            return null;
        }
        
        // Check if we have a GLB file URL
        let modelUrl = null;
        
        if (modelData.output && modelData.output.pbr_model) {
            // For Tripo models, use the local download endpoint
            modelUrl = `/api/models/${modelId}/download`;
            console.log('Using Tripo model URL:', modelUrl);
        } else if (modelData.download_url) {
            // For demo models with download URL
            modelUrl = modelData.download_url;
            console.log('Using demo model URL:', modelUrl);
        }
        
        if (!modelUrl) {
            console.log('No model URL available, using enhanced model');
            return null;
        }
        
        // Load GLB model using GLTFLoader
        return new Promise((resolve, reject) => {
            const loader = new THREE.GLTFLoader();
            
            loader.load(
                modelUrl,
                (gltf) => {
                    console.log('GLB model loaded successfully');
                    const model = gltf.scene;
                    
                    // Center and scale model
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 2 / maxDim;
                    model.scale.setScalar(scale);
                    
                    model.position.sub(center.multiplyScalar(scale));
                    
                    resolve(model);
                },
                (progress) => {
                    const percentage = (progress.loaded / progress.total * 100);
                    updateLoadingProgress(50 + (percentage * 0.3), `Loading model... ${Math.round(percentage)}%`);
                },
                (error) => {
                    console.error('Error loading GLB model:', error);
                    reject(error);
                }
            );
        });
        
    } catch (error) {
        console.error('Error in loadRealModel:', error);
        return null;
    }
}

// Create enhanced 3D model as fallback
function createEnhancedModel() {
    console.log('Creating enhanced model for:', modelId);
    
    const group = new THREE.Group();
    
    // Create a more interesting model based on the model ID or prompt
    const prompt = modelData?.prompt?.toLowerCase() || '';
    
    if (prompt.includes('car') || prompt.includes('vehicle') || prompt.includes('motorcycle')) {
        console.log('Creating vehicle model');
        // Car-like model
        const bodyGeometry = new THREE.BoxGeometry(0.3, 0.15, 0.2);
        const bodyMaterial = new THREE.MeshPhongMaterial({ 
            color: 0xff4444,
            metalness: 0.8,
            roughness: 0.2
        });
        const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
        body.position.set(0, 0.075, 0);
        group.add(body);
        
        // Wheels
        const wheelGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.02, 8);
        const wheelMaterial = new THREE.MeshPhongMaterial({ color: 0x333333 });
        
        const wheels = [
            { x: 0.1, y: 0, z: 0.08 },
            { x: 0.1, y: 0, z: -0.08 },
            { x: -0.1, y: 0, z: 0.08 },
            { x: -0.1, y: 0, z: -0.08 }
        ];
        
        wheels.forEach(pos => {
            const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
            wheel.rotation.z = Math.PI / 2;
            wheel.position.set(pos.x, pos.y, pos.z);
            group.add(wheel);
        });
        
    } else if (prompt.includes('robot') || prompt.includes('android')) {
        console.log('Creating robot model');
        // Robot-like model
        const headGeometry = new THREE.BoxGeometry(0.15, 0.15, 0.15);
        const headMaterial = new THREE.MeshPhongMaterial({ color: 0x888888 });
        const head = new THREE.Mesh(headGeometry, headMaterial);
        head.position.set(0, 0.2, 0);
        group.add(head);
        
        const bodyGeometry = new THREE.BoxGeometry(0.2, 0.25, 0.1);
        const bodyMaterial = new THREE.MeshPhongMaterial({ color: 0x666666 });
        const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
        body.position.set(0, 0, 0);
        group.add(body);
        
    } else {
        console.log('Creating default enhanced model');
        // Default enhanced cube
        const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
        const material = new THREE.MeshPhongMaterial({ 
            color: 0x4ecdc4,
            transparent: true,
            opacity: 0.9
        });
        const cube = new THREE.Mesh(geometry, material);
        cube.position.set(0, 0, 0);
        group.add(cube);
    }
    
    console.log('Enhanced model created successfully');
    return group;
}

// Start fallback AR (3D viewer)
async function startFallbackAR() {
    console.log('Starting fallback AR (3D viewer)');
    
    try {
        // Try to load model data, but don't fail if it doesn't work
        const modelLoaded = await loadModelData();
        if (!modelLoaded) {
            console.log('Model data loading failed, using default model');
            showToast('Using default 3D model', 'info');
        }
        
        const viewer = document.getElementById('arViewer');
        viewer.innerHTML = `
            <div class="ar-viewer-content">
                <div>
                    <div class="ar-ready-icon">
                        <i class="fas fa-cube"></i>
                    </div>
                    <div class="ar-ready-title">3D Viewer Mode</div>
                    <div class="ar-ready-subtitle">AR not available on this device<br>Use mouse/touch to interact with the 3D model</div>
                    <div class="loading-progress" id="loadingProgress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            <div class="progress-text" id="progressText">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Initialize Three.js viewer
        await init3DViewer();
        
    } catch (error) {
        console.error('Error in startFallbackAR:', error);
        showToast('Error starting 3D viewer', 'error');
    }
}

// Initialize 3D viewer
async function init3DViewer() {
    console.log('Initializing 3D viewer');
    updateLoadingProgress(10, 'Initializing 3D viewer...');
    
    try {
        const viewer = document.getElementById('arViewer');
        if (!viewer) {
            console.error('arViewer element not found');
            return;
        }
        
        const width = viewer.clientWidth;
        const height = viewer.clientHeight;
        
        console.log('Viewer dimensions:', width, 'x', height);
        
        // Check if Three.js is loaded
        if (typeof THREE === 'undefined') {
            console.error('Three.js not loaded');
            updateLoadingProgress(100, 'Three.js not available');
            return;
        }
        
        // Create scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);
        
        // Create camera
        const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
        camera.position.set(0, 0, 5);
        
        // Create renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        
        updateLoadingProgress(30, 'Setting up renderer...');
        
        // Clear viewer and add renderer
        viewer.innerHTML = '';
        viewer.appendChild(renderer.domElement);
        
        // Add lights
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 10, 5);
        directionalLight.castShadow = true;
        scene.add(directionalLight);
        
        updateLoadingProgress(50, 'Loading 3D model...');
        
        // Try to load real model first
        let model = null;
        try {
            model = await loadRealModel();
        } catch (error) {
            console.error('Error loading real model:', error);
        }
        
        if (!model) {
            console.log('Using enhanced model as fallback');
            model = createEnhancedModel();
        }
        
        if (model) {
            model.castShadow = true;
            model.receiveShadow = true;
            scene.add(model);
            
            // Center the model properly
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            // Center the model at origin
            model.position.sub(center);
            
            // Adjust camera to fit model
            const maxDim = Math.max(size.x, size.y, size.z);
            const fov = camera.fov * (Math.PI / 180);
            let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
            
            camera.position.z = cameraZ * 1.5;
            camera.lookAt(0, 0, 0);
            
            updateLoadingProgress(80, 'Setting up controls...');
            
            // Add controls
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.target.set(0, 0, 0);
            controls.update();
            
            updateLoadingProgress(100, '3D viewer ready!');
            
            console.log('3D scene initialized successfully');
            
            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                if (model) {
                    model.rotation.x += 0.005;
                    model.rotation.y += 0.01;
                }
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
            
        } else {
            console.error('Failed to create model');
            updateLoadingProgress(100, 'Failed to load model');
        }
        
    } catch (error) {
        console.error('Error initializing 3D viewer:', error);
        updateLoadingProgress(100, 'Error initializing viewer');
    }
}

// Reset AR session
function resetAR() {
    console.log('Reset button clicked');
    
    try {
        // End AR session if active
        if (arSession) {
            arSession.end();
            arSession = null;
            console.log('AR session ended');
        }
        
        // Reset the viewer to initial state
        const viewer = document.getElementById('arViewer');
        viewer.innerHTML = `
            <div class="ar-viewer-content">
                <div>
                    <div class="ar-ready-icon">
                        <i class="fas fa-vr-cardboard"></i>
                    </div>
                    <div class="ar-ready-title">AR Viewer Ready</div>
                    <div class="ar-ready-subtitle">Click "Start AR" to begin the augmented reality experience</div>
                    <div class="loading-progress" id="loadingProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            <div class="progress-text" id="progressText">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Reset button states
        const startButton = document.querySelector('.ar-button.primary');
        if (startButton) {
            startButton.innerHTML = '<i class="fas fa-play"></i> Start AR';
            startButton.disabled = false;
        }
        
        showToast('AR viewer reset successfully', 'success');
        console.log('AR viewer reset completed');
        
    } catch (error) {
        console.error('Error resetting AR viewer:', error);
        showToast('Failed to reset AR viewer', 'error');
    }
}

// Capture AR screenshot
function captureAR() {
    console.log('Capture button clicked');
    
    // Visual feedback
    const captureBtn = document.getElementById('captureBtn');
    const originalText = captureBtn.innerHTML;
    captureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Capturing...';
    captureBtn.disabled = true;
    
    try {
        if (arSession) {
            // Capture WebXR frame
            console.log('Capturing AR screenshot...');
            showToast('AR screenshot captured!', 'success');
        } else {
            // Capture 3D viewer
            const viewer = document.getElementById('arViewer');
            const canvas = viewer.querySelector('canvas');
            
            if (canvas) {
                console.log('Capturing 3D viewer screenshot...');
                
                // Create a temporary canvas to ensure high quality
                const tempCanvas = document.createElement('canvas');
                const tempContext = tempCanvas.getContext('2d');
                
                // Set canvas size to match the original
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                
                // Draw the canvas content
                tempContext.drawImage(canvas, 0, 0);
                
                // Create download link
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                link.download = `ar-screenshot-${modelId}-${timestamp}.png`;
                link.href = tempCanvas.toDataURL('image/png', 0.9);
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Screenshot saved successfully!', 'success');
                console.log('Screenshot saved:', link.download);
            } else {
                console.log('No canvas found for screenshot');
                showToast('No 3D model to capture', 'error');
            }
        }
    } catch (error) {
        console.error('Error capturing screenshot:', error);
        showToast('Failed to capture screenshot', 'error');
    } finally {
        // Reset button state
        setTimeout(() => {
            captureBtn.innerHTML = originalText;
            captureBtn.disabled = false;
        }, 1000);
    }
}

// Exit AR session
function exitAR() {
    console.log('Exit button clicked');
    
    try {
        // End AR session if active
        if (arSession) {
            arSession.end();
            arSession = null;
            console.log('AR session ended');
        }
        
        // Navigate back to model viewer
        showToast('Exiting AR viewer...', 'info');
        setTimeout(() => {
            window.location.href = `/view/${modelId}`;
        }, 1000);
        
    } catch (error) {
        console.error('Error exiting AR viewer:', error);
        // Force navigation even if there's an error
        window.location.href = `/view/${modelId}`;
    }
}

// Show toast notification
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
        color: white;
        padding: 15px 25px;
        border-radius: 25px;
        z-index: 10000;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => document.body.removeChild(toast), 300);
    }, 3000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOMContentLoaded triggered for model-specific AR viewer');
    checkDeviceCompatibility();
    console.log('Model ID:', modelId);
    
    // Add button event listeners with immediate feedback
    const startButton = document.querySelector('.ar-button.primary');
    if (startButton) {
        console.log('Start button found, adding event listener');
        startButton.addEventListener('click', function() {
            console.log('Start AR button clicked');
            // Immediate visual feedback
            startButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
            startButton.disabled = true;
            
            // Call startAR with error handling
            startAR().catch(error => {
                console.error('Error in startAR:', error);
                startButton.innerHTML = '<i class="fas fa-play"></i> Start AR';
                startButton.disabled = false;
                showToast('Failed to start AR: ' + error.message, 'error');
            });
        });
    } else {
        console.error('Start button not found');
    }
    
    const resetButton = document.querySelector('.ar-button:nth-child(2)');
    if (resetButton) {
        resetButton.addEventListener('click', resetAR);
    }
    
    const captureButton = document.querySelector('.ar-button:nth-child(3)');
    if (captureButton) {
        captureButton.addEventListener('click', captureAR);
    }
    
    const exitButton = document.querySelector('.ar-button:nth-child(4)');
    if (exitButton) {
        exitButton.addEventListener('click', exitAR);
    }
});
</script>
{% endblock %} 